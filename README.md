# DAMI Protocol - 分散型重複排除コンテンツ管理システム

## 🌟 DAMIとは？
DAMIは、あらゆるデータ（動画やJSONデータなど）を小さな部品（チャンク）に分けて、それらをインターネット上に分散して保存・共有するためのシステムです。

BitTorrentのように、ユーザー同士で直接データをやり取りできる P2P 通信を使用していますが、より使いやすく、安全に設計されています。

### CIDの階層構造

DAMIでは、データの整合性と信頼性を確保するため、3層のCID（Content Identifier）構造を採用しています：

1. **xll (下位CID)**:
   - 個々のチャンクを識別するCID
   - データの最小単位を表す
   - 直接的なコンテンツへの参照

2. **yll (中位CID)**:
   - 分割前の全体データを表すCID
   - xllのレシピとして機能
   - チャンクの結合順序を保持

3. **zll (上位CID)**:
   - 複数のyllをまとめた履歴管理用CID
   - 投稿順序の改ざん防止
   - データの信頼性を確保
   - 時系列データの整合性を保証

この3層構造により、データの完全性、順序性、改ざん防止を実現しています。

## 💡 なぜDAMIが必要なのか？

### データ重複の現状問題

現代のデジタル社会では、同じデータが無数に複製され、保存されています：

- 同じ画像が何百万回もストレージに保存される
- 同じ動画が無数のサーバーに複製される
- 同じ文書が数え切れないデバイスに保存される

これは、まるで同じ服を300枚、3000枚と無限に購入し、すべてを保管しようとするようなものです。
その結果：

- ストレージの無駄遣い
- 検索効率の低下
- 管理コストの増大
- エネルギー消費の増加

### DAMIの解決アプローチ

DAMIは、この問題に対して「スマートな整理整頓」を提案します：

1. **データの一意性確保**:
   - 同じデータは1回だけ保存
   - 必要な場所から参照する形式
   - 重複を自動的に検出・統合

2. **効率的なデータ管理**:
   - データを意味のある単位（チャンク）に分割
   - 共通部分を再利用
   - 必要な部分だけを取得可能

3. **分散型の信頼性**:
   - P2Pネットワークでデータを共有
   - 改ざん防止の仕組み
   - データの永続性を確保

## 🎯 主な特徴

### 1. 賢いファイル管理
- 大きなファイルを自動的に小さな部品に分割
- 必要な部分だけを順番にダウンロード可能
- ファイルの種類（動画、JSON等）を自動判別

### 2. 使いやすい設計
- プログレスバーでアップロード/ダウンロードの進捗を表示
- 途中から再開可能なアップロード/ダウンロード
- シンプルなAPIで簡単に利用可能

### 3. 安全性と信頼性
- データの整合性を自動チェック
- P2P通信の暗号化
- 分散保存による高可用性

## 🎯 具体的な使用例

### 1. SNSプラットフォーム

従来の方式：
```json
{
  "post_id_1": {
    "user": "田中太郎",
    "date": "2024-01-01",
    "content": "明けましておめでとう！"
  },
  "post_id_2": {
    "user": "田中太郎",  // 同じユーザー情報が重複
    "date": "2024-01-01",  // 同じ日付が重複
    "content": "今年もよろしく！"
  }
}
```

DAMI方式：
```json
// ユーザーチャンク（1回だけ保存）
{
  "cid_user": {
    "name": "田中太郎",
    "references": 2  // 2つの投稿から参照
  }
}

// 日付チャンク（1回だけ保存）
{
  "cid_date": {
    "value": "2024-01-01",
    "references": 2  // 2つの投稿から参照
  }
}

// 投稿は参照情報のみ
{
  "post_id_1": {
    "user": "cid_user",
    "date": "cid_date",
    "content": "cid_content_1"
  }
}
```

### 2. 動画共有プラットフォーム

- 同じ動画の異なる品質版を個別に保存する代わりに
- 基本データを1回保存し、異なる品質設定を参照として管理

### 3. 分散型ストレージ

- 共通のライブラリやフレームワークを1回だけ保存
- 必要な場所から参照する形式で再利用

## 🌟 DAMIがもたらす革新

1. **ストレージ効率の劇的な改善**:
   - データ重複の排除による容量削減
   - 効率的なキャッシュ管理
   - 帯域幅使用の最適化

2. **環境への貢献**:
   - ストレージハードウェアの需要削減
   - エネルギー消費の削減
   - データセンターの効率化

3. **コスト削減**:
   - ストレージコストの低減
   - 運用コストの削減
   - スケーリングコストの最適化

## 🚀 使い方

### インストールと準備
1. **必要なもの**:
   - Node.js (v16以上)
   - IPFS（データの保存に使用）

2. **インストール**:
```bash
# パッケージのインストール
npm install

# IPFSデーモンの起動
ipfs daemon

# プロジェクトの起動
npm run dev
```

### 基本的な使い方

1. **ファイルのアップロード**:
```typescript
// ファイルを分割してアップロード
const chunks = await chunkManager.splitVideoIntoChunks(videoFile);

// 進捗表示付きでアップロード
for (const chunk of chunks) {
  console.log(`アップロード進捗: ${chunk.progress * 100}%`);
}
```

2. **ファイルのダウンロード**:
```typescript
// 進捗表示付きでダウンロード
for await (const { data, progress } of chunkManager.streamChunks(metadataCid)) {
  console.log(`ダウンロード進捗: ${progress * 100}%`);
  // データを処理
}
```

## 📁 プロジェクト構造

```
dami-ts/
├── src/
│   ├── core/           # 核となる機能
│   │   ├── entities/   # データの定義
│   │   └── services/   # 主要な機能の定義
│   └── infra/          # 外部システムとの連携
│       ├── ipfs/       # ファイル保存の処理
│       └── p2p/        # P2P通信の処理
├── example-app/         # デモアプリケーション
│   ├── src/            # アプリケーションのソースコード
│   │   ├── components/ # Reactコンポーネント
│   │   ├── hooks/      # カスタムフック
│   │   └── core/       # DAMIノード実装
│   └── public/         # 静的ファイル
└── docs/               # ドキュメント
```

### 主要なファイルと役割

1. **`Chunk.ts`** (データの最小単位)
   - ファイルを分割した一つ一つの部品を管理
   - サイズ、種類、作成日時などの情報を保持

2. **`ChunkManager.ts`** (データ操作の中心)
   - ファイルの分割・結合
   - アップロード/ダウンロード
   - ファイルタイプの判定

3. **`HistoryManager.ts`** (履歴管理)
   - チェーン構造による履歴管理
   - データの整合性検証
   - 古いデータの自動クリーンアップ

4. **`NetworkManager.ts`** (ネットワーク管理)
   - ピアの発見と管理
   - レイテンシベースの最適化
   - 地理的な分散管理

## 🔧 開発者向け情報

詳細な開発者向けドキュメントは以下を参照してください：

- [開発者ガイド](docs/developer-guide.md) - 実装の詳細と使用例
- [技術仕様書](docs/TECHNICAL.md) - アーキテクチャと設計の詳細

### テストと検証
```bash
# 基本的なテスト実行
npm test

# example-appの起動
cd example-app
npm install
npm run dev

# 検証用データセットの生成
npm run generate-test-data

# パフォーマンス計測
npm run measure-performance
```

### 主な技術スタック
- TypeScript: 安全なコード開発
- IPFS: 分散ストレージ
- libp2p: P2P通信
- Jest: テスト
- sharp: 画像処理
- fluent-ffmpeg: 動画処理

## 🌱 今後の開発予定

- [ ] より効率的な動画分割（キーフレームでの分割）
- [ ] キャッシュ機能の強化
- [ ] エラーリカバリー機能の改善
- [ ] WebブラウザでのP2P通信対応

## 👥 コントリビューション
1. このリポジトリをフォーク
2. 新しい機能用のブランチを作成: `git checkout -b feature/amazing-feature`
3. 変更をコミット: `git commit -m 'Add amazing feature'`
4. リモートブランチにプッシュ: `git push origin feature/amazing-feature`
5. プルリクエストを作成

## 🔬 検証計画

DAMIプロトコルの実用性を検証するため、example-appを用いた包括的な検証を実施します：

### 検証の目的
- データの重複排除効率の実測
- ストリーミングパフォーマンスの評価
- P2P通信の効率測定
- システムリソース使用量の分析
- 実際のユーザー体験の評価

### 主な検証指標
```typescript
const TARGET_METRICS = {
  performance: {
    uploadSpeed: '5MB/秒以上',
    initialLoadTime: '3秒以内',
    deduplication: '90%以上の重複検出'
  },
  reliability: {
    dataIntegrity: '100%',
    uptime: '99.9%',
    errorRate: '0.1%未満'
  },
  userExperience: {
    responseTime: '100ms以内',
    bufferingRate: '0.1%未満'
  }
};
```

詳細な検証計画は[example-app-verification.md](docs/example-app-verification.md)を参照してください。
